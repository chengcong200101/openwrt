name: Build ImmortalWrt 24.10.4 Firmware

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  FIRMWARE_NAME: ImmortalWrt-24.10.4-x86-64-Custom

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check available disk space
      run: |
        echo "=== Checking disk space ==="
        df -h
        AVAILABLE_KB=$(df / --output=avail | tail -1)
        REQUIRED_KB=50000000
        if [ $AVAILABLE_KB -lt $REQUIRED_KB ]; then
          echo "Error: Insufficient disk space, need at least 50GB"
          echo "Currently available: $((AVAILABLE_KB / 1024 / 1024))GB"
          exit 1
        else
          echo "Disk space sufficient: $((AVAILABLE_KB / 1024 / 1024))GB available"
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install essential build dependencies
      timeout-minutes: 15
      run: |
        echo "=== Installing build dependencies ==="
        sudo apt-get update
        sudo apt-get upgrade -y
        
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          subversion \
          quilt \
          libelf-dev \
          patchelf \
          cmake \
          ninja-build \
          pkg-config \
          gperf \
          antlr3 \
          gcc-multilib \
          g++-multilib
        
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        echo "Dependencies installed successfully"

    - name: Setup ccache
      run: |
        echo "=== Setting up ccache ==="
        sudo mkdir -p /usr/lib/ccache
        which ccache && ccache --version
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

    - name: Clone ImmortalWrt source
      timeout-minutes: 10
      run: |
        echo "=== Cloning ImmortalWrt source ==="
        git clone https://github.com/immortalwrt/immortalwrt.git --depth=1
        
        if [ $? -ne 0 ]; then
          echo "Clone failed, exiting"
          exit 1
        fi
        
        cd immortalwrt
        git fetch --tags
        LATEST_TAG=$(git tag -l "24.10.4*" | sort -V | tail -1)
        if [ -n "$LATEST_TAG" ]; then
          echo "Using tag: $LATEST_TAG"
          git checkout $LATEST_TAG
        else
          echo "Using latest stable version"
        fi
        
        echo "Source preparation completed"
        pwd
        ls -la

    - name: Update and install feeds
      timeout-minutes: 20
      run: |
        echo "=== Updating and installing feeds ==="
        cd immortalwrt
        
        for i in 1 2 3; do
          echo "Updating feeds (attempt $i)..."
          ./scripts/feeds update -a
          if [ $? -eq 0 ]; then
            echo "Feeds updated successfully"
            break
          else
            echo "Feeds update failed, retrying..."
            sleep 10
          fi
        done
        
        ./scripts/feeds install -a
        
        echo "Feeds installation completed"

    - name: Create custom configuration
      run: |
        echo "=== Creating custom configuration ==="
        cd immortalwrt
        
        # 创建基础配置文件 - 使用简单的echo命令避免复杂的heredoc语法
        {
          echo "CONFIG_TARGET_x86=y"
          echo "CONFIG_TARGET_x86_64=y"
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y"
          echo ""
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y"
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
          echo "CONFIG_TARGET_IMAGES_GZIP=y"
          echo ""
          echo "CONFIG_PACKAGE_block-mount=y"
          echo "CONFIG_PACKAGE_fdisk=y"
          echo "CONFIG_PACKAGE_usbutils=y"
          echo "CONFIG_PACKAGE_pciutils=y"
          echo ""
          echo "CONFIG_PACKAGE_kmod-usb-core=y"
          echo "CONFIG_PACKAGE_kmod-usb-ohci=y"
          echo "CONFIG_PACKAGE_kmod-usb-uhci=y"
          echo "CONFIG_PACKAGE_kmod-usb-storage=y"
          echo "CONFIG_PACKAGE_kmod-usb-storage-extras=y"
          echo "CONFIG_PACKAGE_kmod-usb2=y"
          echo "CONFIG_PACKAGE_kmod-usb3=y"
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y"
          echo "CONFIG_PACKAGE_kmod-fs-vfat=y"
          echo "CONFIG_PACKAGE_kmod-fs-ntfs=y"
          echo ""
          echo "CONFIG_PACKAGE_dnsmasq=y"
          echo "CONFIG_PACKAGE_firewall=y"
          echo "CONFIG_PACKAGE_iptables=y"
          echo "CONFIG_PACKAGE_ip6tables=y"
          echo "CONFIG_PACKAGE_ppp=y"
          echo "CONFIG_PACKAGE_ppp-mod-pppoe=y"
          echo ""
          echo "CONFIG_PACKAGE_luci=y"
          echo "CONFIG_PACKAGE_luci-base=y"
          echo "CONFIG_PACKAGE_luci-compat=y"
          echo "CONFIG_PACKAGE_luci-lib-base=y"
          echo "CONFIG_PACKAGE_luci-lib-ipkg=y"
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
          echo ""
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y"
          echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y"
          echo "CONFIG_PACKAGE_luci-app-autoupdate=y"
          echo "CONFIG_PACKAGE_luci-app-ddns-go=y"
          echo "CONFIG_PACKAGE_luci-app-firewall=y"
          echo "CONFIG_PACKAGE_luci-app-lucky=y"
          echo "CONFIG_PACKAGE_luci-app-netdata=y"
          echo "CONFIG_PACKAGE_luci-app-openclash=y"
          echo "CONFIG_PACKAGE_luci-app-package-manager=y"
          echo "CONFIG_PACKAGE_luci-app-passwall=y"
          echo "CONFIG_PACKAGE_luci-app-smartdns=y"
          echo "CONFIG_PACKAGE_luci-app-ttyd=y"
          echo "CONFIG_PACKAGE_luci-app-turboacc=y"
          echo "CONFIG_PACKAGE_luci-app-upnp=y"
          echo "CONFIG_PACKAGE_luci-app-vsftpd=y"
          echo "CONFIG_PACKAGE_luci-app-wol=y"
          echo "CONFIG_PACKAGE_luci-app-zerotier=y"
          echo "CONFIG_PACKAGE_luci-theme-argon=y"
          echo ""
          echo "CONFIG_PACKAGE_adguardhome=y"
          echo "CONFIG_PACKAGE_ddns-go=y"
          echo "CONFIG_PACKAGE_smartdns=y"
          echo "CONFIG_PACKAGE_ttyd=y"
          echo "CONFIG_PACKAGE_zerotier=y"
          echo "CONFIG_PACKAGE_vsftpd=y"
          echo "CONFIG_PACKAGE_netdata=y"
          echo "CONFIG_PACKAGE_wol=y"
          echo "CONFIG_PACKAGE_miniupnpd=y"
          echo ""
          echo "CONFIG_CCACHE=y"
          echo "CONFIG_BUILD_LOG=y"
        } > .config

        echo "Checking plugin availability..."
        if ./scripts/feeds list | grep -q "luci-app-control-webrestriction"; then
          echo "CONFIG_PACKAGE_luci-app-control-webrestriction=y" >> .config
        fi
        
        if ./scripts/feeds list | grep -q "luci-app-control-weburl"; then
          echo "CONFIG_PACKAGE_luci-app-control-weburl=y" >> .config
        fi

        echo "Configuration file created successfully"

    - name: Download package sources
      timeout-minutes: 30
      run: |
        echo "=== Downloading package sources ==="
        cd immortalwrt
        
        make defconfig
        
        for i in 1 2 3; do
          echo "Downloading packages (attempt $i)..."
          make download -j8
          if [ $? -eq 0 ]; then
            echo "Package download successful"
            break
          else
            echo "Package download failed, retrying..."
            sleep 15
          fi
        done

    - name: Build toolchain and dependencies
      timeout-minutes: 60
      run: |
        echo "=== Building toolchain and dependencies ==="
        cd immortalwrt
        
        echo "Building toolchain..."
        make toolchain/compile -j$(nproc) V=s
        
        echo "Building base dependencies..."
        make -j1 V=s 2>&1 | tee -a build-deps.log

    - name: Build firmware
      timeout-minutes: 180
      run: |
        echo "=== Building firmware ==="
        cd immortalwrt
        
        echo "Disk space before build:"
        df -h
        
        echo "Starting firmware build..."
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        echo "=== Checking build results ==="
        if ls bin/targets/x86/64/*.img.gz 1> /dev/null 2>&1; then
          echo "Firmware build successful!"
          ls -la bin/targets/x86/64/*.img.gz
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "Firmware build failed"
          echo "Check build.log for errors"
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Upload firmware artifacts
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          immortalwrt/bin/targets/x86/64/*.img.gz
          immortalwrt/bin/targets/x86/64/sha256sums
          immortalwrt/bin/targets/x86/64/config.buildinfo
        retention-days: 30
        if-no-files-found: error

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/build-deps.log
          immortalwrt/.config
        retention-days: 7

    - name: Notify build status
      if: always()
      run: |
        echo "=== Build Status ==="
        if [ "$FIRMWARE_BUILT" = "true" ]; then
          echo "Build completed successfully!"
          echo "Firmware can be downloaded from Artifacts"
        else
          echo "Build failed"
          echo "Please check build-logs for details"
        fi
