name: Build ImmortalWrt 24.10.4 Firmware

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  FIRMWARE_NAME: ImmortalWrt-24.10.4-x86-64-Custom

jobs:
  build:
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        # å‡†å¤‡å¤šä¸ªrunneré€‰é¡¹ä»¥é˜²æŸä¸ªä¸å¯ç”¨
        runner: [ubuntu-22.04]

    steps:
    - name: Check available disk space
      run: |
        echo "=== æ£€æŸ¥ç£ç›˜ç©ºé—´ ==="
        df -h
        AVAILABLE_KB=$(df / --output=avail | tail -1)
        REQUIRED_KB=50000000  # 50GB
        if [ $AVAILABLE_KB -lt $REQUIRED_KB ]; then
          echo "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘50GB"
          echo "å½“å‰å¯ç”¨: $((AVAILABLE_KB / 1024 / 1024))GB"
          exit 1
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³: $((AVAILABLE_KB / 1024 / 1024))GB å¯ç”¨"
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install essential build dependencies
      timeout-minutes: 15
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get update
        sudo apt-get upgrade -y
        
        # åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          subversion \
          quilt \
          libelf-dev \
          patchelf \
          cmake \
          ninja-build \
          pkg-config \
          gperf \
          antlr3 \
          gcc-multilib g++-multilib
        
        # æ¸…ç†ç¼“å­˜èŠ‚çœç©ºé—´
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: Setup ccache
      run: |
        echo "=== è®¾ç½®ccacheåŠ é€Ÿç¼–è¯‘ ==="
        sudo mkdir -p /usr/lib/ccache
        which ccache && ccache --version
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

    - name: Clone ImmortalWrt source (24.10.4)
      timeout-minutes: 10
      run: |
        echo "=== å…‹éš† ImmortalWrt 24.10.4 æºç  ==="
        # ä½¿ç”¨æµ…å±‚å…‹éš†èŠ‚çœæ—¶é—´å’Œç©ºé—´
        git clone https://github.com/immortalwrt/immortalwrt.git --depth=1 --branch=v24.10.4
        
        if [ $? -ne 0 ]; then
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨masteråˆ†æ”¯"
          git clone https://github.com/immortalwrt/immortalwrt.git --depth=1
          cd immortalwrt
          # æŸ¥æ‰¾24.10.4ç›¸å…³æäº¤
          git fetch --tags
          LATEST_24_TAG=$(git tag -l "24.10.4*" | sort -V | tail -1)
          if [ -n "$LATEST_24_TAG" ]; then
            echo "ä½¿ç”¨æ ‡ç­¾: $LATEST_24_TAG"
            git checkout $LATEST_24_TAG
          else
            echo "ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬"
          fi
        else
          cd immortalwrt
        fi
        
        echo "âœ… æºç å‡†å¤‡å®Œæˆ"
        pwd
        ls -la

    - name: Update and install feeds
      timeout-minutes: 20
      run: |
        echo "=== æ›´æ–°å’Œå®‰è£… feeds ==="
        cd immortalwrt
        
        # æ›´æ–°feedsï¼Œå¸¦é‡è¯•æœºåˆ¶
        for i in 1 2 3; do
          echo "å°è¯•æ›´æ–°feeds (ç¬¬ $i æ¬¡)..."
          ./scripts/feeds update -a
          if [ $? -eq 0 ]; then
            echo "âœ… feedsæ›´æ–°æˆåŠŸ"
            break
          else
            echo "âŒ feedsæ›´æ–°å¤±è´¥ï¼Œé‡è¯•..."
            sleep 10
          fi
        done
        
        # å®‰è£…åŸºç¡€åŒ…
        ./scripts/feeds install -a
        
        echo "âœ… feedså®‰è£…å®Œæˆ"

    - name: Create custom configuration
      run: |
        echo "=== åˆ›å»ºè‡ªå®šä¹‰é…ç½® ==="
        cd immortalwrt
        
        # åˆ›å»ºåŸºç¡€é…ç½®æ–‡ä»¶
        cat > .config << 'EOF'
# Targeté…ç½®
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# é•œåƒé…ç½®
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_VDI_IMAGES=y
CONFIG_VMDK_IMAGES=y
CONFIG_VHDX_IMAGES=y

# åŸºç¡€ç³»ç»Ÿ
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_usbutils=y
CONFIG_PACKAGE_pciutils=y

# å†…æ ¸æ¨¡å—
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb-uhci=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-extras=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-ntfs=y

# ç½‘ç»œåŸºç¡€
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y

# LUCIåŸºç¡€
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-base=y
CONFIG_PACKAGE_luci-lib-ipkg=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# ç”¨æˆ·æ‰€éœ€æ’ä»¶
CONFIG_PACKAGE_luci-app-adguardhome=y
CONFIG_PACKAGE_luci-app-attendedsysupgrade=y
CONFIG_PACKAGE_luci-app-autoupdate=y
CONFIG_PACKAGE_luci-app-ddns-go=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-lucky=y
CONFIG_PACKAGE_luci-app-netdata=y
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-package-manager=y
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_luci-app-ttyd=y
CONFIG_PACKAGE_luci-app-turboacc=y
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_luci-app-vsftpd=y
CONFIG_PACKAGE_luci-app-wol=y
CONFIG_PACKAGE_luci-app-zerotier=y
CONFIG_PACKAGE_luci-theme-argon=y

# æ’ä»¶ä¾èµ–
CONFIG_PACKAGE_adguardhome=y
CONFIG_PACKAGE_ddns-go=y
CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_ttyd=y
CONFIG_PACKAGE_zerotier=y
CONFIG_PACKAGE_vsftpd=y
CONFIG_PACKAGE_netdata=y
CONFIG_PACKAGE_wol=y
CONFIG_PACKAGE_miniupnpd=y

# ç¼–è¯‘ä¼˜åŒ–
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF

        # æ£€æŸ¥æ’ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ³¨é‡Šæ‰
        echo "æ£€æŸ¥æ’ä»¶å¯ç”¨æ€§..."
        if ! ./scripts/feeds list | grep -q "luci-app-control-webrestriction"; then
          echo "# CONFIG_PACKAGE_luci-app-control-webrestriction ä¸å­˜åœ¨" >> .config
        else
          echo "CONFIG_PACKAGE_luci-app-control-webrestriction=y" >> .config
        fi
        
        if ! ./scripts/feeds list | grep -q "luci-app-control-weburl"; then
          echo "# CONFIG_PACKAGE_luci-app-control-weburl ä¸å­˜åœ¨" >> .config
        else
          echo "CONFIG_PACKAGE_luci-app-control-weburl=y" >> .config
        fi

        echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: Download package sources
      timeout-minutes: 30
      run: |
        echo "=== ä¸‹è½½è½¯ä»¶åŒ…æºç  ==="
        cd immortalwrt
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        make defconfig
        
        # ä¸‹è½½æ‰€æœ‰éœ€è¦çš„åŒ…ï¼Œå¸¦é‡è¯•æœºåˆ¶
        for i in 1 2 3; do
          echo "ä¸‹è½½åŒ…æ–‡ä»¶ (ç¬¬ $i æ¬¡å°è¯•)..."
          make download -j8
          if [ $? -eq 0 ]; then
            echo "âœ… åŒ…ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "âŒ åŒ…ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
            sleep 15
          fi
        done
        
        # æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§
        find dl/ -name "*.zip" -exec unzip -t {} \; > /dev/null 2>&1 || true
        find dl/ -name "*.tar.gz" -exec tar -tzf {} > /dev/null 2>&1 \; || true

    - name: Build toolchain and dependencies
      timeout-minutes: 60
      run: |
        echo "=== ç¼–è¯‘å·¥å…·é“¾å’Œä¾èµ– ==="
        cd immortalwrt
        
        # ç¼–è¯‘å·¥å…·é“¾
        echo "ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/compile -j$(nproc) V=s
        
        # ç¼–è¯‘åŸºç¡€ä¾èµ–
        echo "ç¼–è¯‘åŸºç¡€ä¾èµ–..."
        make -j1 V=s 2>&1 | tee -a build-deps.log

    - name: Build firmware
      timeout-minutes: 180  # 3å°æ—¶è¶…æ—¶
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd immortalwrt
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
        df -h
        
        # å¼€å§‹ç¼–è¯‘å›ºä»¶
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        echo "=== æ£€æŸ¥ç¼–è¯‘ç»“æœ ==="
        if ls bin/targets/x86/64/*.img.gz 1> /dev/null 2>&1; then
          echo "ğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
          ls -la bin/targets/x86/64/*.img.gz
          echo "FIRMWARE_BUILT=true" >> $GITHUB_ENV
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
          echo "æ£€æŸ¥build.logä¸­çš„é”™è¯¯ä¿¡æ¯"
          echo "FIRMWARE_BUILT=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Upload firmware artifacts
      if: env.FIRMWARE_BUILT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          immortalwrt/bin/targets/x86/64/*.img.gz
          immortalwrt/bin/targets/x86/64/sha256sums
          immortalwrt/bin/targets/x86/64/config.buildinfo
        retention-days: 30
        if-no-files-found: error

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/build-deps.log
          immortalwrt/.config
        retention-days: 7

    - name: Notify build status
      if: always()
      run: |
        echo "=== ç¼–è¯‘çŠ¶æ€ ==="
        if [ "$FIRMWARE_BUILT" = "true" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
          echo "å›ºä»¶å¯åœ¨Artifactsä¸­ä¸‹è½½"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "è¯·æ£€æŸ¥build-logsä¸­çš„æ—¥å¿—æ–‡ä»¶"
        fi